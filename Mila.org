#+TITLE:  Mila.cat Configuration and Deployment
#+AUTHOR: Dmitri Brengauz
#+EMAIL:  dmitri@momus.net
#+DATE:   3 March 2016
#+TAGS:   freebsd technical
#+DESCRIPTION: Setup for Mila.cat development and deploy

* What am I doing?
  The idea of literate programing holds obvious attractions; the idea
  of literate DevOps even more so: in theory, an enitre site can be
  constructed from one well written Org-mode file, and even a complete
  testing/development environment that mirrors the site can be spun up
  with just a few keystrokes. For me, this idea went from hopeful
  Google term to something approaching reality when I stumbled across
  [[http://www.howardism.org/Technical/Emacs/literate-devops.html][this blog post]].

*** Preliminary steps:
    1. Create project directory, create this file inside of it.
    2. Create a Vagrantfile in this directory for dev/testing
    3. Incorporate Vagrantfile into this document
    4. Use steps divined for Vagrantfile to configure production
       server on Digital Ocean
    6. Profit!!!

*** TODO [0/2] Modify [[https://github.com/wunki/vagrant-freebsd/blob/master/Vagrantfile][wunki's]] Vagrantfile, to suit our needs.:

     - [ ] Resize the hard disk. Default is ridiculously small.
       The virtual disk dosen't seem to grow. [[http://tomasz.korwel.net/2014/01/03/growing-zfs-pool/][Growing ZFS Pool]] may help

     - [ ] Out of the box, wunki uses Virtual box. Change this to libvirt for a speedup.
     #+BEGIN_SRC ruby :tangle Vagrantfile
       # -*- mode: ruby; -*-

       
       ENV['VAGRANT_DEFAULT_PROVIDER'] = 'virtualbox'

       Vagrant.configure("2") do |config|
         config.vm.guest = :freebsd
         config.vm.network "public_network"
     #+END_SRC
     
     - [ ] Initially, NFS shared folders don't work. Right now, I don't care.

       
     #+BEGIN_SRC ruby :tangle Vagrantfile
       # Use NFS as a shared folder
       #config.vm.synced_folder ".", "/vagrant", :nfs => true, id: "vagrant-root"

       config.vm.provider :virtualbox do |vb, override|
         override.vm.box_url = "https://wunki.org/files/freebsd-10.2-amd64-wunki.box"
         override.vm.box = "freebsd-10.2-amd64-wunki"

         # vb.customize ["startvm", :id, "--type", "gui"]
         vb.customize ["modifyvm", :id, "--memory", "512"]
         vb.customize ["modifyvm", :id, "--cpus", "2"]
         vb.customize ["modifyvm", :id, "--hwvirtex", "on"]
         vb.customize ["modifyvm", :id, "--audio", "none"]
                  vb.customize ["modifyvm", :id, "--nictype1", "virtio"]
                  vb.customize ["modifyvm", :id, "--nictype2", "virtio"]
                end
       end
     #+END_SRC
     - [ ] Set up [[http://blog.osteel.me/posts/2015/01/25/how-to-use-vagrant-for-local-web-development.html][port forwarding]] to view the lovely Rails-Elm app in it's full glory.

*** Starting the VM
    Because of lag time, currently running "vagrant up" in an eterm buffer.

***** Vagrant vagrancies
     - virtual box depends on kernel modules, these have to manually
       be updated whenever the kernel packages are updated.
       1. Run `VBoxManage --version` to see if this is the problem.
       2. Then `sudo /etc/init.d/vboxdrv setup` to fix it.
     - `vagrant up` should be ready to go.
     - use `[[https://github.com/dergachev/vagrant-vbox-snapshot][vagrant plugin install vagrant-vbox-snapshot]]` for our
       current VBox setup
     - `vagrant snapshot take BOXNAME  NAME` before we go too crazy
        

*** Verifying the ssh connection
     #+BEGIN_SRC sh :dir /ssh:MilaVM:~
     uname -a
     #+END_SRC

     #+RESULTS:
     : FreeBSD vagrant-freebsd-10 10.2-RELEASE FreeBSD 10.2-RELEASE #0 r286666: Wed Aug 12 15:26:37 UTC 2015     root@releng1.nyi.freebsd.org:/usr/obj/usr/src/sys/GENERIC  amd64

*** Updating operating system before installing software
    `freebsd-update fetch` and `install` are meant to be used
    interactively, from here we can run the cron script
    #+BEGIN_SRC sh :dir /ssh:MilaVM:~
      sudo freebsd-update cron
    #+END_SRC
    update pkg packages
    #+BEGIN_SRC sh :dir /ssh:MilaVM:~
     sudo pkg upgrade --yes --quiet
    #+END_SRC

    #+RESULTS:
    | src component not installed                      | skipped |


* FreeBSD Rails server general system setup

*** Adjustments
    - Source directory for tarball installs
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~
        mkdir ~/src
      #+END_SRC
    - No eterm-color termcap entry for FreeBSD. WTF.
      Currently [[http://stackoverflow.com/a/8819340/768772][THIS]] dosen't seem to work.
      #+BEGIN_SRC sh :tangle /ssh:freebsd@mila.cat:~/src/emacs-ansi-termcap
            # Termcap entry for eterm-color (taken from $TERMCAP set by emacs and formatted)
            eterm-color|Emacs term.el terminal emulator term-protocol-version 0.96:\
                   :am:bs:mi:pt:xn:\
                   :Co#8:co#166:li#48:pa#64:\
                   :@7=\E[4~:AB=\E[4%dm:AF=\E[3%dm:AL=\E[%dL:DC=\E[%dP:\
                   :DL=\E[%dM:DO=\E[%dB:IC=\E[%d@:LE=\E[%dD:RI=\E[%dC:\
                   :UP=\E[%dA:al=\E[L:bl=^G:cb=\E[1K:cd=\E[J:ce=\E[K:\
                   :cl=\E[H\E[J:cm=\E[%i%d;%dH:cr=^M:cs=\E[%i%d;%dr:dc=\E[P:\
                   :dl=\E[M:do=^J:ei=\E[4l:ho=\E[H:im=\E[4h:kD=^[[3~:\
                   :kN=\E[6~:kP=\E[5~:kb=^?:kd=\EOB:kh=\E[1~:kl=\EOD:\
                   :kr=\EOC:ku=\EOA:le=^H:md=\E[1m:me=\E[m:mk=\E[8m:mr=\E[7m:\
                   :nd=\E[C:op=\E[39;49m:r1=\Ec:rc=\E8:sc=\E7:se=\E[27m:sf=^J:\
                   :so=\E[7m:ta=^I:ue=\E[m:\
                   :up=\E[A:us=\E[4m:
      #+END_SRC

      #+BEGIN_SRC sh :tangle /ssh:MilaVM:~/src/emacs-ansi-termcap
                        eterm-color|Emacs term.el terminal emulator term-protocol-version 0.96:\
                           :am:bs:mi:pt:xn:\
                           :Co#8:co#166:li#48:pa#64:\
                           :@7=\E[4~:AB=\E[4%dm:AF=\E[3%dm:AL=\E[%dL:DC=\E[%dP:\
                           :DL=\E[%dM:DO=\E[%dB:IC=\E[%d@:LE=\E[%dD:RI=\E[%dC:\
                           :UP=\E[%dA:al=\E[L:bl=^G:cb=\E[1K:cd=\E[J:ce=\E[K:\
                           :cl=\E[H\E[J:cm=\E[%i%d;%dH:cr=^M:cs=\E[%i%d;%dr:dc=\E[P:\
                           :dl=\E[M:do=^J:ei=\E[4l:ho=\E[H:im=\E[4h:kD=^[[3~:\
                           :kN=\E[6~:kP=\E[5~:kb=^?:kd=\EOB:kh=\E[1~:kl=\EOD:\
                           :kr=\EOC:ku=\EOA:le=^H:md=\E[1m:me=\E[m:mk=\E[8m:mr=\E[7m:\
                           :nd=\E[C:op=\E[39;49m:r1=\Ec:rc=\E8:sc=\E7:se=\E[27m:sf=^J:\
                           :so=\E[7m:ta=^I:ue=\E[m:\
                           :up=\E[A:us=\E[4m:
      #+END_SRC

      #+BEGIN_SRC sh :results output :dir /ssh:freebsd@mila.cat:~/src
        sudo cp ./emacs-ansi-termcap  /usr/share/misc/termcap
        sudo 
      #+END_SRC
      

*** Needful software
    - Git, of course
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~
        sudo pkg install --yes --quiet git
        #For rails
        sudo pkg install --yes --quiet -r bison curl gdbm git libtool libxml2 libxslt
      #+END_SRC

      #+RESULTS:

   

*** Installing Ruby and Gems
    - Just to make things simple and perhaps secure, let's use FreeBSD's
      ruby package.  This will be my system ruby, so create a symbolic ling between
      the executable and /usr/bin/ruby
 
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~
        sudo pkg install --yes --quiet ruby23 node node-devel
        sudo ln -s /usr/local/bin/ruby23 /usr/bin/ruby
        ruby --version
      #+END_SRC

      #+RESULTS:
      | The  | most    | recent      | version  |     of | packages          | are | already | installed |
      | ruby | 2.3.0p0 | (2015-12-25 | revision | 53290) | [amd64-freebsd10] |     |         |           |

    - Gems: download from Github, use ruby to install system-wide.
      This leaves a 23MB src directory, which could be removed if
      desperate for space.
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~/src
        #git clone https://github.com/rubygems/rubygems
        #sudo ruby ~/src/rubygems/setup.rb
        sudo ln -s /usr/local/bin/gem23 /usr/bin/gem
        gem --version
      #+END_SRC

      #+RESULTS:
      : 2.6.3


*** Postgres
    Started with [[https://jasonk2600.wordpress.com/2010/01/11/installing-postgresql-on-freebsd/][this tutorial]]
    Install and enable on startup
    #+BEGIN_SRC sh :dir /ssh:MilaVM:~
      sudo pkg install --yes --quiet postgresql93-server postgresql93-client
      sudo echo postgresql_enable="YES" >> /etc/rc.conf
    #+END_SRC
    - Initialize PostgreSQL database cluster
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~
      sudo /usr/local/etc/rc.d/postgresql initdb
      #+END_SRC

      #+RESULTS:
            | The  files belonging to this database system                              |
            | will be owned by user pgsql                                               |
            | This user must also own the server process                                |
            | The database cluster will be initialized with locale C                    |
            | The default text search configuration will be set to english              |
            | Data  page checksums are disabled.                                        |
            | Success.  You can now start the database server using:                    |
            | /usr/local/bin/postgres -D   /usr/local/pgsql/data                        |
            | or                                                                        |
            | /usr/local/bin/pg_ctl   -D   /usr/local/pgsql/data   -l   logfile   start |
    - /usr/local/pgsql/data/postgresql.conf
      set listen_address to 'localhost'
    - use password hash authentication for all hosts and users
      /usr/local/pgsql/data/pg_hba.conf
    - Start DBMS for first time and add a new super-user
      (with database and role creation rights
      - /usr/local/etc/rc.d/postgresql start
      - sudo su pgsql
      - createuser -sdrP /username/
      - Enter password for new role:
      - Enter it again:



* Mila.cat Rails-Elm app

*** Install rails gem
    #+BEGIN_SRC sh :dir /ssh:MilaVM:~
      sudo pkg install --yes node-devel www/npm
      sudo gem install rails  --no-rdoc --no-ri
    #+END_SRC


***  [[https://www.digitalocean.com/community/tutorials/how-to-setup-ruby-on-rails-with-postgres][Postgres and Rails]]
     - Install the posrgres gem:
       #+BEGIN_SRC  sh :dir /ssh:MilaVM:~
       sudo gem install pg --no-doc --no-ri
       #+END_SRC
     - Create a user for the app:
         - sudo  su - pgsql
         - createuser --createdb -P -R -e /username/ 

***  Initialize application
    - Note taken on [2016-04-26 Tue 18:49]
     #+BEGIN_SRC sh :dir /ssh:MilaVM:~
       rails new mila --database=postgresql 
     #+END_SRC

     #+RESULTS:
     | [1m[32m  | create[0m                                              |                                                 |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | README.rdoc                                     |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | Rakefile                                        |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config.ru                                       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | .gitignore                                      |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | Gemfile                                         |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app                                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/assets/javascripts/application.js           |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/assets/stylesheets/application.css          |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/controllers/application_controller.rb       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/helpers/application_helper.rb               |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/views/layouts/application.html.erb          |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/assets/images/.keep                         |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/mailers/.keep                               |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/models/.keep                                |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/controllers/concerns/.keep                  |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | app/models/concerns/.keep                       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | bin                                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | bin/bundle                                      |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | bin/rails                                       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | bin/rake                                        |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | bin/setup                                       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config                                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/routes.rb                                |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/application.rb                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/environment.rb                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/secrets.yml                              |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/environments                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/environments/development.rb              |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/environments/production.rb               |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/environments/test.rb                     |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/initializers                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/initializers/assets.rb                   |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/initializers/backtrace_silencers.rb      |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/initializers/cookies_serializer.rb       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/initializers/filter_parameter_logging.rb |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/initializers/inflections.rb              |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/initializers/mime_types.rb               |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/initializers/session_store.rb            |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/initializers/wrap_parameters.rb          |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/locales                                  |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/locales/en.yml                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/boot.rb                                  |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | config/database.yml                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | db                                              |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | db/seeds.rb                                     |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | lib                                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | lib/tasks                                       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | lib/tasks/.keep                                 |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | lib/assets                                      |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | lib/assets/.keep                                |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | log                                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | log/.keep                                       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | public                                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | public/404.html                                 |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | public/422.html                                 |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | public/500.html                                 |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | public/favicon.ico                              |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | public/robots.txt                               |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/fixtures                                   |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/fixtures/.keep                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/controllers                                |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/controllers/.keep                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/mailers                                    |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/mailers/.keep                              |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/models                                     |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/models/.keep                               |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/helpers                                    |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/helpers/.keep                              |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/integration                                |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/integration/.keep                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | test/test_helper.rb                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | tmp/cache                                       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | tmp/cache/assets                                |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | vendor/assets/javascripts                       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | vendor/assets/javascripts/.keep                 |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | vendor/assets/stylesheets                       |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | create[0m                                              | vendor/assets/stylesheets/.keep                 |             |                                  |            |           |           |            |     |         |            |         |       |
     | [1m[32m  | run[0m                                                 | bundle                                          | install     |                                  |            |           |           |            |     |         |            |         |       |
     | Fetching     | gem                                                      | metadata                                        | from        | https://rubygems.org/........... |            |           |           |            |     |         |            |         |       |
     | Fetching     | version                                                  | metadata                                        | from        | https://rubygems.org/...         |            |           |           |            |     |         |            |         |       |
     | Fetching     | dependency                                               | metadata                                        | from        | https://rubygems.org/..          |            |           |           |            |     |         |            |         |       |
     | Resolving    | dependencies............................................ |                                                 |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | rake                                                     | 11.1.2                                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | i18n                                                     | 0.7.0                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | json                                                     | 1.8.3                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | minitest                                                 | 5.8.4                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | thread_safe                                              | 0.3.5                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | builder                                                  | 3.2.2                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | erubis                                                   | 2.7.0                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | mini_portile2                                            | 2.0.0                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | rack                                                     | 1.6.4                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | mime-types-data                                          | 3.2016.0221                                     |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | arel                                                     | 6.0.3                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | debug_inspector                                          | 0.0.2                                           | with        | native                           | extensions |           |           |            |     |         |            |         |       |
     | Using        | bundler                                                  | 1.11.2                                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | byebug                                                   | 8.2.4                                           | with        | native                           | extensions |           |           |            |     |         |            |         |       |
     | Installing   | coffee-script-source                                     | 1.10.0                                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | execjs                                                   | 2.6.0                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | thor                                                     | 0.19.1                                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | concurrent-ruby                                          | 1.0.1                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | multi_json                                               | 1.11.2                                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | pg                                                       | 0.18.4                                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | sass                                                     | 3.4.22                                          |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | tilt                                                     | 2.0.2                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | spring                                                   | 1.7.1                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | rdoc                                                     | 4.2.2                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | tzinfo                                                   | 1.2.2                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | nokogiri                                                 | 1.6.7.2                                         |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | rack-test                                                | 0.6.3                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | mime-types                                               | 3.0                                             |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | binding_of_caller                                        | 0.7.2                                           | with        | native                           | extensions |           |           |            |     |         |            |         |       |
     | Installing   | coffee-script                                            | 2.4.1                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | uglifier                                                 | 3.0.0                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | sprockets                                                | 3.6.0                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | sdoc                                                     | 0.4.1                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | activesupport                                            | 4.2.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | loofah                                                   | 2.0.3                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | mail                                                     | 2.6.4                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | rails-deprecated_sanitizer                               | 1.0.3                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | globalid                                                 | 0.3.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | activemodel                                              | 4.2.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | jbuilder                                                 | 2.4.1                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | rails-html-sanitizer                                     | 1.0.3                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | rails-dom-testing                                        | 1.0.7                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | activejob                                                | 4.2.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | activerecord                                             | 4.2.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | actionview                                               | 4.2.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | actionpack                                               | 4.2.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | actionmailer                                             | 4.2.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | railties                                                 | 4.2.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | sprockets-rails                                          | 3.0.4                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | coffee-rails                                             | 4.1.1                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | jquery-rails                                             | 4.1.1                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Using        | rails                                                    | 4.2.6                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | sass-rails                                               | 5.0.4                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | web-console                                              | 2.3.0                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Installing   | turbolinks                                               | 2.5.3                                           |             |                                  |            |           |           |            |     |         |            |         |       |
     | Bundle       | complete!                                                | 12                                              | Gemfile     | dependencies,                    | 55         | gems      | now       | installed. |     |         |            |         |       |
     | Use          | `bundle                                                  | show                                            | [gemname]`  | to                               | see        | where     | a         | bundled    | gem | is      | installed. |         |       |
     | Post-install | message                                                  | from                                            | rdoc:       |                                  |            |           |           |            |     |         |            |         |       |
     | Depending    | on                                                       | your                                            | version     | of                               | ruby,      | you       | may       | need       | to  | install | ruby       | rdoc/ri | data: |
     |              |                                                          |                                                 |             |                                  |            |           |           |            |     |         |            |         |       |
     | <=           | 1.8.6                                                    | :                                               | unsupported |                                  |            |           |           |            |     |         |            |         |       |
     | =            | 1.8.7                                                    | :                                               | gem         | install                          | rdoc-data; | rdoc-data | --install |            |     |         |            |         |       |
     | =            | 1.9.1                                                    | :                                               | gem         | install                          | rdoc-data; | rdoc-data | --install |            |     |         |            |         |       |
     | >=           | 1.9.2                                                    | :                                               | nothing     | to                               | do!        | Yay!      |           |            |     |         |            |         |       |

***** TODO [3/4] Configure the application database

      - [X] Take databases.yml and secretls.yml out of version controll.

      - [X] Make one database.yml for testing and dev and another for
        production What I have should work fine, but maybe look more
        into config/database.yml In general database.yml should look
        like this:
            #+BEGIN_SRC ruby
              development:
                adapter: postgresql
                encoding: unicode
                database: myapp_development
                pool: 5
                username: myapp
                password: password1

              test:
                adapter: postgresql
                encoding: unicode
                database: myapp_test
                pool: 5
                username: myapp
                password: password1
           #+END_SRC
           but I am leaving it out of this file for now.

      - [X] Copy over [DOCUMENTROOT]/mila_config files to
        current/config for database.yml and secrets.yml
        #+BEGIN_SRC sh :results output :dir /ssh:freebsd@mila.cat:/usr/local/www/mila/current/config
          cp /usr/local/www/mila/mila_conf/database.yml  database.yml
          cp /usr/local/www/mila/mila_conf/secrets.yml   secrets.yml
          ls -lh *.yml
        #+END_SRC

        #+RESULTS:
        : -rw-r--r--  1 freebsd  rails   428B May  7 02:06 database.yml
        : -rw-r--r--  1 freebsd  rails   963B May  7 02:06 secrets.yml

      - [ ] Automate this in Capistrano for future deployments, or set up actually working ENVs 


      


***** Gemfile:
      made to look like the book, except version numbers with default Rails gave.
      Except web-console
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~/mila/
      bundle install --without production
      #+END_SRC

      #+RESULTS:
      | Using        | rake                       |      11.1.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | i18n                       |       0.7.0 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | json                       |       1.8.3 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | minitest                   |       5.8.4 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | thread_safe                |       0.3.5 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | builder                    |       3.2.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | erubis                     |       2.7.0 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | mini_portile2              |       2.0.0 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | rack                       |       1.6.4 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | mime-types-data            | 3.2016.0221 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | arel                       |       6.0.3 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | debug_inspector            |       0.0.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | byebug                     |       8.2.4 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | coffee-script-source       |      1.10.0 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | execjs                     |       2.6.0 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | thor                       |      0.19.1 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | concurrent-ruby            |       1.0.1 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | multi_json                 |      1.11.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | pg                         |      0.18.4 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | bundler                    |      1.11.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | sass                       |      3.4.22 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | tilt                       |       2.0.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | spring                     |       1.7.1 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | rdoc                       |       4.2.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | tzinfo                     |       1.2.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | nokogiri                   |     1.6.7.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | rack-test                  |       0.6.3 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | mime-types                 |         3.0 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | binding_of_caller          |       0.7.2 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | coffee-script              |       2.4.1 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | uglifier                   |       3.0.0 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | sprockets                  |       3.6.0 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | sdoc                       |       0.4.1 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | activesupport              |       4.2.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | loofah                     |       2.0.3 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | mail                       |       2.6.4 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | rails-deprecated_sanitizer |       1.0.3 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | globalid                   |       0.3.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | activemodel                |       4.2.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | jbuilder                   |       2.4.1 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | rails-html-sanitizer       |       1.0.3 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | rails-dom-testing          |       1.0.7 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | activejob                  |       4.2.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | activerecord               |       4.2.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | actionview                 |       4.2.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | actionpack                 |       4.2.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | actionmailer               |       4.2.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | railties                   |       4.2.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | sprockets-rails            |       3.0.4 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | coffee-rails               |       4.1.1 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | jquery-rails               |       4.1.1 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | rails                      |       4.2.6 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | sass-rails                 |       5.0.4 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | web-console                |       2.3.0 |            |               |      |       |                 |                 |     |    |                 |
      | Using        | turbolinks                 |       2.5.3 |            |               |      |       |                 |                 |     |    |                 |
      | [32mBundle | complete!                  |          12 | Gemfile    | dependencies, | 55   | gems  | now             | installed.[0m |     |    |                 |
      | [32mGems   | in                         |         the | group      | production    | were | not   | installed.[0m |                 |     |    |                 |
      | [32mUse    | `bundle                    |        show | [gemname]` | to            | see  | where | a               | bundled         | gem | is | installed.[0m |

*****  rake db:setup
       #+BEGIN_SRC   sh :dir /ssh:MilaVM:~/mila/
       bundle exec rake db:setup
       bundle exec rake db:migrate
       #+END_SRC

       #+RESULTS:

***** starting server
      #+BEGIN_SRC    sh :dir /ssh:MilaVM:~/mila/
       bundle exec rails s -b 0.0.0.0      
      #+END_SRC

      #+RESULTS:

      
* Rails

*** Root Files

***** Gemfile
      - Source
              #+BEGIN_SRC ruby :tangle /ssh:MilaVM:mila/Gemfile
                source 'https://rubygems.org'


                gem 'rails', '4.2.6'
                gem 'pg', '~> 0.15'
                # Use SCSS for stylesheets
                gem 'sass-rails', '~> 5.0'
                # Use Uglifier as compressor for JavaScript assets
                gem 'uglifier', '>= 1.3.0'
                # Use CoffeeScript for .coffee assets and views
                gem 'coffee-rails', '~> 4.1.0'
                # See https://github.com/rails/execjs#readme for more supported runtimes
                # gem 'therubyracer', platforms: :ruby

                # Use jquery as the JavaScript library
                gem 'jquery-rails'
                # Turbolinks makes following links in your web application faster. 
                # Read more: https://github.com/rails/turbolinks
                gem 'turbolinks'
                # Build JSON APIs with ease. Read more: https://github.com/rails/jbuilder
                gem 'jbuilder', '~> 2.0'
                # bundle exec rake doc:rails generates the API under doc/api.
                gem 'sdoc', '~> 0.4.0', group: :doc

                # Use ActiveModel has_secure_password
                gem 'bcrypt', '~> 3.1.7'

                # Use Unicorn as the app server
                # gem 'unicorn'

                # Use Capistrano for deployment
                gem 'capistrano-rails', group: :development

                group :development, :test do
                  # Call 'byebug' anywhere in the code to stop execution and get a debugger console
                  gem 'byebug'
                end

                group :development do
                  # Access an IRB console on exception pages or by using <%= console %> in views
                  gem 'web-console', '~> 2.0'

                  # Spring speeds up development by keeping your application running in the background.
                  # Read more: https://github.com/rails/spring
                  gem 'spring'
                end


              #+END_SRC


      - Bundle update
        #+BEGIN_SRC sh  :results output :dir /ssh:MilaVM:~/mila/
        bundle update
        #+END_SRC

        #+RESULTS:
        #+begin_example
        Fetching gem metadata from https://rubygems.org/...........
        Fetching version metadata from https://rubygems.org/...
        Fetching dependency metadata from https://rubygems.org/..
        Resolving dependencies.........................
        Using rake 11.1.2
        Using i18n 0.7.0
        Using json 1.8.3
        Using minitest 5.8.4
        Using thread_safe 0.3.5
        Using builder 3.2.2
        Using erubis 2.7.0
        Using mini_portile2 2.0.0
        Using rack 1.6.4
        Using mime-types-data 3.2016.0221
        Using arel 6.0.3
        Using net-ssh 3.1.1
        Using bcrypt 3.1.11
        Using debug_inspector 0.0.2
        Using bundler 1.11.2
        [32mInstalling byebug 8.2.5 (was 8.2.4) with native extensions[0m
        Using capistrano-harrow 0.4.0
        Using coffee-script-source 1.10.0
        Using execjs 2.6.0
        Using thor 0.19.1
        Using concurrent-ruby 1.0.1
        [32mInstalling multi_json 1.11.3 (was 1.11.2)[0m
        Using pg 0.18.4
        Using spring 1.7.1
        Using rdoc 4.2.2
        Using tzinfo 1.2.2
        Using nokogiri 1.6.7.2
        Using rack-test 0.6.3
        Using mime-types 3.0
        Using net-scp 1.2.1
        Using binding_of_caller 0.7.2
        Using coffee-script 2.4.1
        Using uglifier 3.0.0
        Using sprockets 3.6.0
        Using sdoc 0.4.1
        Using activesupport 4.2.6
        Using loofah 2.0.3
        Using mail 2.6.4
        Using sshkit 1.10.0
        Using rails-deprecated_sanitizer 1.0.3
        Using globalid 0.3.6
        Using activemodel 4.2.6
        Using jbuilder 2.4.1
        Using rails-html-sanitizer 1.0.3
        Using airbrussh 1.0.1
        Using rails-dom-testing 1.0.7
        Using activejob 4.2.6
        Using activerecord 4.2.6
        Using capistrano 3.5.0
        Using actionview 4.2.6
        Using capistrano-bundler 1.1.4
        Using actionpack 4.2.6
        Using capistrano-rails 1.1.6
        Using actionmailer 4.2.6
        Using railties 4.2.6
        Using sprockets-rails 3.0.4
        Using coffee-rails 4.1.1
        Using rails 4.2.6
        Using web-console 2.3.0
        Using turbolinks 2.5.3
        [32mBundle updated![0m
        [32mGems in the group production were not installed.[0m
#+end_example
        

*** app

***** Assets

******* javascripts

********* application.js
          - source
            #+BEGIN_SRC javascript :tangle /ssh:MilaVM:mila/app/assets/javascripts/application.js
              // This is a manifest file that'll be compiled into application.js, which will include all the files
              // listed below.
              //
              // Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
              // or any plugin's vendor/assets/javascripts directory can be referenced here using a relative path.
              //
              // It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
              // compiled file.
              //
              // Read Sprockets README (https://github.com/rails/sprockets#sprockets-directives) for details
              // about supported directives.


              //= require turbolinks
              //= require_tree .
            #+END_SRC



***** views

******* layouts

********* application.html.erb
          - source
            #+BEGIN_SRC html :tangle /ssh:MilaVM:/home/vagrant/mila/app/views/layouts/application.html.erb
              <!DOCTYPE html>
              <html>
                <head>
                  <title>Mila</title>
                  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
                  <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
                  <%= csrf_meta_tags %>
                </head>
                <body>

                  <%= yield %>
                  
                </body>
              </html>

            #+END_SRC

********* TODO home.html.erb
          Make a more "custom" Elm compiplation target that works better with application.html.erb
          - copied from Mila.elm/index.html
            #+BEGIN_SRC sh :results output :dir Mila.elm
              elm make Mila.elm --warn --output home.html
              scp home.html MilaVM:mila/app/views/static_pages/home.html.erb
            #+END_SRC

            #+RESULTS:
            : Success! Compiled 1 modules.
            : Successfully generated home.html


*** Test

***** Controller

******* Static Pages
        #+NAME: static_pages_controller_test.rb
        #+BEGIN_SRC ruby  :tangle /ssh:MilaVM:~/mila/test/controllers/static_pages_controller_test.rb
          require 'test_helper'

          class StaticPagesControllerTest < ActionController::TestCase
            test "should get home" do
              get :home
              assert_response :success
            end

            test "should get help" do
              get :help
              assert_response :success
            end

             test "should get about" do
               get :about
               assert_response :success
             end

          end 

        #+END_SRC

******* Running Tests
        - just this controller's test
          #+BEGIN_SRC sh :results output  :dir /ssh:MilaVM:~/mila/
            bundle exec rake test test/controllers/static_pages_controller_test.rb
          #+END_SRC

          #+RESULTS:
          : Run options: --seed 36006
          : 
          : # Running:
          : 
          : ...
          : 
          : Finished in 0.491675s, 6.1016 runs/s, 6.1016 assertions/s.
          : 
          : 3 runs, 3 assertions, 0 failures, 0 errors, 0 skips


*** Config

***** Routes
      - routes.rb
        #+BEGIN_SRC ruby :tangle /ssh:MilaVM:/home/vagrant/mila/config/routes.rb
          Rails.application.routes.draw do

            # Priority is based on order of creation: first created -> highest priority.
            # See how all your routes lay out with "rake routes".

            # Root of your site routed with "root"
            root 'static_pages#home'

            ## Static pages controller serves static pages.

            get '/help' => 'static_pages#help'
            get '/about' => 'static_pages#about'

          end
        #+END_SRC


***** environments
      - development
        #+BEGIN_SRC ruby :tangle /ssh:MilaVM:mila/config/environments/development.rb
          Rails.application.configure do
            # Settings specified here will take precedence over those in config/application.rb.

            #Allow rails console to be accessed by non-Internet routed networks
            config.web_console.whitelisted_ips = '192.168.0.0/16', '10.0.0.0/8', '172.16.0.0/12'
            
            # In the development environment your application's code is reloaded on
            # every request. This slows down response time but is perfect for development
            # since you don't have to restart the web server when you make code changes.
            config.cache_classes = false

            # Do not eager load code on boot.
            config.eager_load = false

            # Show full error reports and disable caching.
            config.consider_all_requests_local       = true
            config.action_controller.perform_caching = false

            # Don't care if the mailer can't send.
            config.action_mailer.raise_delivery_errors = false

            # Print deprecation notices to the Rails logger.
            config.active_support.deprecation = :log

            # Raise an error on page load if there are pending migrations.
            config.active_record.migration_error = :page_load

            # Debug mode disables concatenation and preprocessing of assets.
            # This option may cause significant delays in view rendering with a large
            # number of complex assets.
            config.assets.debug = true

            # Asset digests allow you to set far-future HTTP expiration dates on all assets,
            # yet still be able to expire them through the digest params.
            config.assets.digest = true

            # Adds additional error checking when serving assets at runtime.
            # Checks for improperly declared sprockets dependencies.
            # Raises helpful error messages.
            config.assets.raise_runtime_errors = true

            # Raises error for missing translations
            # config.action_view.raise_on_missing_translations = true
          end

        #+END_SRC

    

***** application.rb
      #+BEGIN_SRC ruby :tangle /ssh:MilaVM:mila/config/application.rb
        require File.expand_path('../boot', __FILE__)

        require 'rails/all'

        # Require the gems listed in Gemfile, including any gems
        # you've limited to :test, :development, or :production.
        Bundler.require(*Rails.groups)

        module Mila
          class Application < Rails::Application
            # Settings in config/environments/* take precedence over those specified here.
            # Application configuration should go into files in config/initializers
            # -- all .rb files in that directory are automatically loaded.

            # Set Time.zone default to the specified zone and make Active Record auto-convert to this zone.
            # Run "rake -D time" for a list of tasks for finding time zone names. Default is UTC.
            config.time_zone = 'Mountain Time (US & Canada)'

            # The default locale is :en and all translations from config/locales/*.rb,yml are auto loaded.
            # config.i18n.load_path += Dir[Rails.root.join('my', 'locales', '*.{rb,yml}').to_s]
            # config.i18n.default_locale = :de

            # Do not swallow errors in after_commit/after_rollback callbacks.
            config.active_record.raise_in_transactional_callbacks = true

            #Content Compression via Rack::Deflater
            config.middleware.use Rack::Deflater
            
          end
        end

      #+END_SRC


*** Controllers

***** StaticPage Controller
      - Generation
        #+BEGIN_SRC  sh :dir /ssh:MilaVM:~/mila/
          bundle exec rails generate controller StaticPages home help
        #+END_SRC

        #+RESULTS:
        | create | app/controllers/static_pages_controller.rb       |                     |
        | route  | get                                              | 'static_pages/help' |
        | route  | get                                              | 'static_pages/home' |
        | invoke | erb                                              |                     |
        | create | app/views/static_pages                           |                     |
        | create | app/views/static_pages/home.html.erb             |                     |
        | create | app/views/static_pages/help.html.erb             |                     |
        | invoke | test_unit                                        |                     |
        | create | test/controllers/static_pages_controller_test.rb |                     |
        | invoke | helper                                           |                     |
        | create | app/helpers/static_pages_helper.rb               |                     |
        | invoke | test_unit                                        |                     |
        | invoke | assets                                           |                     |
        | invoke | coffee                                           |                     |
        | create | app/assets/javascripts/static_pages.coffee       |                     |
        | invoke | scss                                             |                     |
        | create | app/assets/stylesheets/static_pages.scss         |                     |

******* Source
        #+BEGIN_SRC ruby :tangle /ssh:MilaVM:~/mila/app/controllers/static_pages_controller.rb
          class StaticPagesController < ApplicationController
            def home
            end

            def help
            end

            def about
            end
          end

        #+END_SRC

******* 


***** User Controller


*** Models


* Elm

*** Initializatoin
    1. Create local dir, Mila.elm
       Might as well check into repo.
    2. 
       

*** Mila.elm
    - Source
      #+BEGIN_SRC elm :tangle Mila.elm/Mila.elm
        module Mila (..) where

        import Html exposing (..)
        import Html.Attributes exposing (..)

        import String


        title message times =
          message
            |> String.toUpper
            |> String.repeat times
            |> text

        pageHeader =
          h1 [ ] [ title   "¡Mila! " 3 ]


        pageFooter =
          h3 [ ]
            [ text "pròximament"
            ]

        view =
          div [ id "container" ]
              [ pageHeader, pageFooter ]

        main =
          view        
              
               

      #+END_SRC
    - Compilation
      #+BEGIN_SRC sh :results output :dir Mila.elm
        ##REM: elm package install evancz/elm-html
        elm make Mila.elm --output mila.js
      #+END_SRC

      #+RESULTS:
      : Success! Compiled 0 modules.
      : Successfully generated mila.js




* Deploy: Digital Ocean 

*** [[https://wiki.freebsd.org/BernardSpil/LetsEncrypt][Let's Encrypt!]]
    1. Install Client Software on server.
       #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~/src
       sudo pkg install --yes letsencrypt.sh
       #+END_SRC

       #+RESULTS:
       #+begin_example
       Updating FreeBSD repository catalogue...
       FreeBSD repository is up-to-date.
       All repositories are up-to-date.
       Checking integrity... done (0 conflicting)
       The following 1 package(s) will be affected (of 0 checked):

       New packages to be INSTALLED:
               letsencrypt.sh: 0.0.0.20160229
       [1/1] Installing letsencrypt.sh-0.0.0.20160229...
       [1/1] Extracting letsencrypt.sh-0.0.0.20160229
       Message from letsencrypt.sh-0.0.0.20160229:
       To use this script you should copy the examples in
       /usr/local/etc/letsencrypt.sh/ and at least add a
       domain and a contact mail address.

       You should also copy the openssl.cnf.sample file in
       /usr/local/openssl so you won't get warnings about
       it missing.

       In order to run the script regularly to update
       the certificates add this line to /etc/periodic.conf

       weekly_letsencrypt_enable="YES"

       Additionally the following parameters can be added to
       /etc/periodic.conf

       To run the certification renenewal as a different user
       weekly_letsencrypt_user="_letsencrypt"
       To run a script after the renewal (as root)
       weekly_letsencrypt_deployscript="/usr/local/etc/letsencrypt.sh/deploy.sh"
       #+end_example

       #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~/src
       
       #+END_SRC

    2. Prepare users and directories

       1. Set up a letsencrypt user with the same UID as the https port:
          #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~
            sudo pw groupadd -n _letsencrypt -g 443
            sudo pw useradd  -n _letsencrypt -u 443 -g 443 -d /usr/local/etc/letsencrypt.sh -w no -s /nonexistent
            sudo chown _letsencrypt:_letsencrypt /usr/local/etc/letsencrypt.sh
            sudo chmod 770               /usr/local/etc/letsencrypt.sh
            sudo mkdir -p -m 775    /usr/local/www/.well-known/acme-challenge
            sudo chgrp _letsencrypt /usr/local/www/.well-known/acme-challenge
            ls -alh /usr/local/www | grep well
            ls -lh /usr/local/www/.well-known
            sudo ls -lh /usr/local/etc/letsencrypt.sh
          #+END_SRC

          #+RESULTS:
          : drwxr-xr-x   3 root  wheel   512B May  4 20:14 .well-known
          : total 4
          : drwxrwxr-x  2 root  _letsencrypt   512B May  4 20:14 acme-challenge
          : total 32
          : drwxr-xr-x  2 root  wheel   512B Apr 30 18:39 .acme-challenges
          : -rw-r--r--  1 root  wheel   3.0K Apr 30 18:39 config.sh.example
          : -rw-r--r--  1 root  wheel    73B Apr 30 18:39 domains.txt.example
          : -rw-r--r--  1 root  wheel   2.0K Apr 30 18:39 hook.sh.example

    3. Modify Apache configuraion
       This will live at the bottom of httpd.conf
       #+BEGIN_SRC sh
         ## Remember to uncomment the line which enables SSL!!!
         ## LoadModule ssl_module libexec/apache24/mod_ssl.so
         <Directory "/usr/local/www/.well-known/">
           Options FollowSymLinks
           AllowOverride None
           Require all granted
           Header add Content-Type text/plain
         </Directory>
       #+END_SRC

    4. First run
       #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~
         sudo su -m _letsencrypt -c '/bin/bash /usr/local/bin/letsencrypt.sh --cron'
       #+END_SRC

       #+RESULTS:
      : # INFO: Using main config file /usr/local/etc/letsencrypt.sh/config.sh
      : Processing mila.cat with alternative names: www.mila.cat
      :  + Checking domain name(s) of existing cert... unchanged.
      :  + Checking expire date of existing cert...
      :  + Valid till Aug  2 22:12:00 2016 GMT (Longer than 30 days). Skipping!

    5. Configure periodic job
       automatically renew certificates
       #+BEGIN_SRC /etc/periodic.conf
       weekly_letsencrypt_enable="YES"
       #+END_SRC

    6. [[http://serverfault.com/a/570290][Enable]] HTTPS everywhere:
       add to https.conf:
       #+BEGIN_SRC sh
         RewriteEngine on
         RewriteCond %{SERVER_PORT} !^443$
         RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [NC,R=301,L]
       #+END_SRC



*** Installing Apache
    Start with the [[https://www.freebsd.org/doc/handbook/network-apache.html][Basic Freebsd]] Apache installation:
    - Grab the package and install it:
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~
        sudo pkg install --yes --quiet apache24 
      #+END_SRC

    - Initial run RESULTS:
      | ===>  Creating users and/or groups.
      | Using existing group 'www'.
      | Using existing user 'www'.
      | Message from apache24-2.4.18:
      | To run apache www server from startup, add yes
      | in your /etc/rc.conf. Extra options can be found in startup script.

      | Your hostname must be resolvable using at least 1 mechanism in    |
      | /etc/nsswitch.conf typically DNS or /etc/hosts or apache might    |
      | have issues starting depending on the modules you are using.      |
      |                                                                   |
      | !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! |
      |                                                                   |
      | apache24 default build changed from static MPM to modular MPM     |
      | - more modules are now enabled per default in the port            | 
      | - icons and error pages moved from WWWDIR to DATADIR              |
      |                                                                   |
      | If build with modular MPM and no MPM is  activated in             |
      | httpd.conf, then mpm_prefork will be activated as default         |
      | MPM in etc/apache24/modules.d to keep compatibility with          |
      | existing php/perl/python modules! |         |    |           |    |
      |                                                                   |
      | Please compare the existing httpd.conf with httpd.conf.sample     |
      | and merge missing modules/instructions into httpd.conf!           |
      |                                                                   |
      | !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! |

    - Modify /etc/rc.conf to start apache by default
      This I do directly now, but will script at later day;

    - Apache should start:
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~
      sudo service apache24 start
      #+END_SRC

      #+RESULTS:
      | Performing | sanity    | check | on | apache24 | configuration: |
      | Starting   | apache24. |       |    |          |                |


*** Install [[https://www.phusionpassenger.com/library/walkthroughs/deploy/ruby/ownserver/apache/oss/rubygems_norvm/install_passenger.html][Phusion Passenger]]
    If Passenger is installed from a gem (version 5.0.28), the
    compilation of the Apache2 module fails. Need to install 5.0.29 from github.
    #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~/src
      git clone https://github.com/phusion/passenger.git
    #+END_SRC

    Update submodules, and compile
    #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~/src/passenger
      git submodule update --init --recursive
      sudo ./bin/passenger-install-apache2-module --languages ruby
    #+END_SRC


    - Successful Output
      #+begin_example
      This installer will guide you through the entire installation process. It
      shouldn't take more than 3 minutes in total.

      Here's what you can expect from the installation process:
      
      The Apache 2 module will be installed for you.
      You'll learn how to configure Apache.
      You'll learn how to deploy a Ruby on Rails application.
      
      Don't worry if anything goes wrong. This installer will advise you on how to
      solve any problems.
      
      
      
      --------------------------------------------
      
      Which languages are you interested in?
      
      Override selection with --languages.
      
      ‣ ⬢  Ruby
       ⬡  Python
       ⬡  Node.js
       ⬡  Meteor
      
      --------------------------------------------
      
      Checking for required software...

      Checking for C compiler...
          Found:
          Location: /usr/bin/cc
      Checking for C++ compiler...
          Found:
          Location: /usr/bin/c++
      Checking for Curl development headers with SSL support...
          Found:
          curl-config location: /usr/local/bin/curl-config
          Header location: /usr/local/include/curl/curl.h
          Version: libcurl 7.48.0
          Usable: yes
          Supports SSL: yes
      Checking for Zlib development headers...
          Found: 
          Location:
     Checking for Apache 2...
          Found: 
          Location of httpd: /usr/local/sbin/httpd
          Apache version: 2.4.18
      Checking for Apache 2 development headers...
          Found: yes
          Location of apxs2: /usr/local/sbin/apxs
      Checking for Rake (associated with /usr/local/bin/ruby23)...
          Found: yes
          Location: /usr/local/bin/ruby23 /usr/local/bin/rake
      Checking for OpenSSL support for Ruby...
          Found: yes
      Checking for RubyGems...
          Found: yes
      Checking for Ruby development headers...
          Found: yes
          Location: /usr/local/include/ruby-2.3//ruby.h
      Checking for rack...
          Found: yes
      Checking for Apache Portable Runtime (APR) development headers...
          Found: yes
          Location: /usr/local/bin/apr-1-config
          Version: 1.5.2
      Checking for Apache Portable Runtime Utility (APU) development headers...
          Found: yes
          Location: /usr/local/bin/apu-1-config
          Version: 1.5.4
      
      --------------------------------------------
      
      Checking whether there are multiple Apache installations...
      Only a single installation detected. This is good.
      
      --------------------------------------------
      Compiling and installing Apache 2 module...
      cd /usr/home/freebsd/src/passenger
      # env NOEXEC_DISABLE=1 /usr/local/bin/ruby23 /usr/local/bin/rake RELEASE=yes apache2:clean apache2
      
      c++ -o buildout/common/libpassenger_common/Utils.o  -Isrc/cxx_supportlib -Isrc/cxx_supportlib/vendor-copy -Isrc/cxx_supportlib/vendor-modified -Isrc/cxx_supportlib/vendor-modified/libev -Wno-ambiguous-member-template -Isrc/cxx_supportlib/vendor-copy/libuv/include -D_REENTRANT -I/usr/local/include -Wall -Wextra -Wno-unused-parameter -Wno-parentheses -Wpointer-arith -Wwrite-strings -Wno-long-long -Wno-missing-field-initializers -Wno-ambiguous-member-template -fvisibility=hidden -DVISIBILITY_ATTRIBUTE_SUPPORTED -g -DHAVE_ACCEPT4 -DHAS_SFENCE -DHAS_LFENCE -DPASSENGER_DEBUG -DBOOST_DISABLE_ASSERTS -DHAS_UNORDERED_MAP -c src/cxx_supportlib/Utils.cpp
      c++ -o buildout/common/libpassenger_common/vendor-modified/modp_b64.o  -Isrc/cxx_supportlib -Isrc/cxx_supportlib/vendor-copy -Isrc/cxx_supportlib/vendor-modified -Isrc/cxx_supportlib/vendor-modified/libev -Wno-ambiguous-member-template -Isrc/cxx_supportlib/vendor-copy/libuv/include -O2 -D_REENTRANT -I/usr/local/include -Wall -Wextra -Wno-unused-parameter -Wno-parentheses -Wpointer-arith -Wwrite-strings -Wno-long-long -Wno-missing-field-initializers -Wno-ambiguous-member-template -fvisibility=hidden -DVISIBILITY_ATTRIBUTE_SUPPORTED -g -DHAVE_ACCEPT4 -DHAS_SFENCE -DHAS_LFENCE -DPASSENGER_DEBUG -DBOOST_DISABLE_ASSERTS -DHAS_UNORDERED_MAP -c src/cxx_supportlib/vendor-modified/modp_b64.cpp
      c++ -o buildout/common/libpassenger_common/jsoncpp.o  -Isrc/cxx_supportlib -Isrc/cxx_supportlib/vendor-copy -Isrc/cxx_supportlib/vendor-modified -Isrc/cxx_supportlib/vendor-modified/libev -Wno-ambiguous-member-template -Isrc/cxx_supportlib/vendor-copy/libuv/include -O2 -D_REENTRANT -I/usr/local/include -Wall -Wextra -Wno-unused-parameter -Wno-parentheses -Wpointer-arith -Wwrite-strings -Wno-long-long -Wno-missing-field-initializers -Wno-ambiguous-member-template -fvisibility=hidden -DVISIBILITY_ATTRIBUTE_SUPPORTED -g -DHAVE_ACCEPT4 -DHAS_SFENCE -DHAS_LFENCE -DPASSENGER_DEBUG -DBOOST_DISABLE_ASSERTS -DHAS_UNORDERED_MAP -c src/cxx_supportlib/vendor-modified/jsoncpp/jsoncpp.cpp
      m
      c++ -o buildout/common/libpassenger_common/AppTypes.o  -Isrc/cxx_supportlib -Isrc/cxx_supportlib/vendor-copy -Isrc/cxx_supportlib/vendor-modified -Isrc/cxx_supportlib/vendor-modified/libev -Wno-ambiguous-member-template -Isrc/cxx_supportlib/vendor-copy/libuv/include -D_REENTRANT -I/usr/local/include -Wall -Wextra -Wno-unused-parameter -Wno-parentheses -Wpointer-arith -Wwrite-strings -Wno-long-long -Wno-missing-field-initializers -Wno-ambiguous-member-template -fvisibility=hidden -DVISIBILITY_ATTRIBUTE_SUPPORTED -g -DHAVE_ACCEPT4 -DHAS_SFENCE -DHAS_LFENCE -DPASSENGER_DEBUG -DBOOST_DISABLE_ASSERTS -DHAS_UNORDERED_MAP -c src/cxx_supportlib/AppTypes.cpp
      c++ -o buildout/support-binaries/PassengerAgent buildout/common/libpassenger_common/Logging.o buildout/common/libpassenger_common/Exceptions.o buildout/common/libpassenger_common/Utils/SystemTime.o buildout/common/libpassenger_common/Utils/StrIntUtils.o buildout/common/libpassenger_common/Utils/StrIntUtilsNoStrictAliasing.o buildout/common/libpassenger_common/Utils/IOUtils.o buildout/common/libpassenger_common/Utils.o buildout/common/libpassenger_common/vendor-modified/modp_b64.o buildout/common/libpassenger_common/jsoncpp.o buildout/common/libpassenger_common/UnionStationFilterSupport.o buildout/common/libpassenger_common/Utils/CachedFileStat.o buildout/common/libpassenger_common/Utils/LargeFiles.o buildout/common/libpassenger_common/MemoryKit/mbuf.o buildout/common/libpassenger_common/MemoryKit/palloc.o buildout/common/libpassenger_common/ServerKit/http_parser.o buildout/common/libpassenger_common/ServerKit/Implementation.o buildout/common/libpassenger_common/DataStructures/LString.o buildout/common/libpassenger_common/Utils/Hasher.o buildout/common/libpassenger_common/AppTypes.o buildout/support-binaries/AgentMain.o buildout/support-binaries/AgentBase.o buildout/support-binaries/WatchdogMain.o buildout/support-binaries/CoreMain.o buildout/support-binaries/CoreApplicationPool.o buildout/support-binaries/CoreController.o buildout/support-binaries/UstRouterMain.o buildout/support-binaries/SystemMetricsMain.o buildout/support-binaries/TempDirToucherMain.o buildout/support-binaries/SpawnPreparerMain.o buildout/common/libboost_oxt.a   buildout/libev/.libs/libev.a  -lm buildout/libuv/.libs/libuv.a  -lrt -lpthread -lkvm -L/usr/local/lib -lcurl -lz -lpthread -lrt  
      
      --------------------------------------------
      Almost there!
      
      Please edit your Apache configuration file, and add these lines:
      
       LoadModule passenger_module /usr/home/freebsd/src/passenger/buildout/apache2/mod_passenger.so
       <IfModule mod_passenger.c>
         PassengerRoot /usr/home/freebsd/src/passenger
         PassengerDefaultRuby /usr/local/bin/ruby23
       </IfModule>
      
      After you restart Apache, you are ready to deploy any number of web
      applications on Apache, with a minimum amount of configuration!
      
      Press ENTER when you are done editing.

      --------------------------------------------
      
      Validating installation...
      
      * Checking whether this Passenger install is in PATH...
      
       Please add /usr/home/freebsd/src/passenger/bin to PATH.
       Otherwise you will get "command not found" errors upon running
       any Passenger commands.
      
       Learn more at about PATH at:
      
         https://www.phusionpassenger.com/library/indepth/environment_variables.html#the-path-environment-variable
      
      * Checking whether there are no other Passenger installations... 
      * Checking whether Apache is installed... 
      * Checking whether the Passenger module is correctly configured in Apache... 
      
      Detected 0 error(s), 1 warning(s).
      Press ENTER to continue.
      
      --------------------------------------------
      
      Deploying a web application
      
      To learn how to deploy a web app on Passenger, please follow the deployment
      guide:
      
      https://www.phusionpassenger.com/library/deploy/apache/deploy/
      
      Enjoy Phusion Passenger, a product of Phusion (mwww.phusion.nl :-)
      https://www.phusionpassenger.com
      
      Phusion Passenger is a registered trademark of Hongli Lai & Ninh Bui.
      
      #+end_example

    - Validate Install
      #+BEGIN_SRC sh :results output :dir /ssh:freebsd@mila.cat:~/src/passenger
        sudo ./bin/passenger-config validate-install
        sudo ./bin/passenger-memory-stats 
      #+END_SRC

      #+RESULTS:
      #+begin_example
      * Checking whether this Passenger install is in PATH... (!)

         Please add /usr/home/freebsd/src/passenger/bin to PATH.
         Otherwise you will get "command not found" errors upon running
         any Passenger commands.

         Learn more at about PATH at:

           https://www.phusionpassenger.com/library/indepth/environment_variables.html#the-path-environment-variable

       * Checking whether there are no other Passenger installations...

      Detected 0 error(s), 1 warning(s).
      Version: 5.0.29
      Date   : 2016-05-04 01:30:50 +0000

      ---------- Apache processes ----------
      PID    PPID   VMSize   Resident  Name
      --------------------------------------
      67027  1      92.6 MB  0.5 MB    /usr/local/sbin/httpd -DNOHTTPACCEPT
      67038  67027  92.6 MB  0.4 MB    /usr/local/sbin/httpd -DNOHTTPACCEPT
      67039  67027  92.6 MB  0.0 MB    /usr/local/sbin/httpd -DNOHTTPACCEPT
      67040  67027  92.6 MB  2.8 MB    /usr/local/sbin/httpd -DNOHTTPACCEPT
      67041  67027  92.6 MB  3.7 MB    /usr/local/sbin/httpd -DNOHTTPACCEPT
      67042  67027  92.6 MB  3.5 MB    /usr/local/sbin/httpd -DNOHTTPACCEPT
      67437  67027  92.6 MB  0.0 MB    /usr/local/sbin/httpd -DNOHTTPACCEPT

      -------- Nginx processes ---------

      ----- Passenger processes -----
      -------------------------------
      67030  70.6 MB  1.3 MB    PassengerAgent watchdog
      67034  78.9 MB  8.2 MB    PassengerAgent core
      67036  70.6 MB  1.0 MB    PassengerAgent ust-router
      #+end_example

***** TODO Put passenger in freebsd@mila's $PATH
        

*** /usr/local/etc/apache24/httpd.conf
    Tangling over sudo dosen't seem to work at the moment:
    sh :tangle /sudo:freebsd@Mila.cat:/usr/local/etc/apache24/httpd.conf
    #+BEGIN_SRC sh
      #
      # This is the main Apache HTTP server configuration file.  It contains the
      # configuration directives that give the server its instructions.
      # See <URL:http://httpd.apache.org/docs/2.4/> for detailed information.
      # In particular, see 
      # <URL:http://httpd.apache.org/docs/2.4/mod/directives.html>
      # for a discussion of each configuration directive.
      #
      # Do NOT simply read the instructions in here without understanding
      # what they do.  They're here only as hints or reminders.  If you are unsure
      # consult the online docs. You have been warned.  
      #
      # Configuration and logfile names: If the filenames you specify for many
      # of the server's control files begin with "/" (or "drive:/" for Win32), the
      # server will use that explicit path.  If the filenames do *not* begin
      # with "/", the value of ServerRoot is prepended -- so "logs/access_log"
      # with ServerRoot set to "/usr/local/apache2" will be interpreted by the
      # server as "/usr/local/apache2/logs/access_log", whereas "/logs/access_log" 
      # will be interpreted as '/logs/access_log'.

      #
      # ServerRoot: The top of the directory tree under which the server's
      # configuration, error, and log files are kept.
      #
      # Do not add a slash at the end of the directory path.  If you point
      # ServerRoot at a non-local disk, be sure to specify a local disk on the
      # Mutex directive, if file-based mutexes are used.  If you wish to share the
      # same ServerRoot for multiple httpd daemons, you will need to change at
      # least PidFile.
      #
      ServerRoot "/usr/local"

      #
      # Mutex: Allows you to set the mutex mechanism and mutex file directory
      # for individual mutexes, or change the global defaults
      #
      # Uncomment and change the directory if mutexes are file-based and the default
      # mutex file directory is not on a local disk or is not appropriate for some
      # other reason.
      #
      # Mutex default:/var/run

      #
      # Listen: Allows you to bind Apache to specific IP addresses and/or
      # ports, instead of the default. See also the <VirtualHost>
      # directive.
      #
      # Change this to Listen on specific IP addresses as shown below to 
      # prevent Apache from glomming onto all bound IP addresses.
      #
      #Listen 12.34.56.78:80
      Listen 80

      #
      # Dynamic Shared Object (DSO) Support
      #
      # To be able to use the functionality of a module which was built as a DSO you
      # have to place corresponding `LoadModule' lines at this location so the
      # directives contained in it are actually available _before_ they are used.
      # Statically compiled modules (those listed by `httpd -l') do not need
      # to be loaded here.
      #
      # Example:
      # LoadModule foo_module modules/mod_foo.so
      #
      LoadModule authn_file_module libexec/apache24/mod_authn_file.so
      #LoadModule authn_dbm_module libexec/apache24/mod_authn_dbm.so
      #LoadModule authn_anon_module libexec/apache24/mod_authn_anon.so
      #LoadModule authn_dbd_module libexec/apache24/mod_authn_dbd.so
      #LoadModule authn_socache_module libexec/apache24/mod_authn_socache.so
      LoadModule authn_core_module libexec/apache24/mod_authn_core.so
      LoadModule authz_host_module libexec/apache24/mod_authz_host.so
      LoadModule authz_groupfile_module libexec/apache24/mod_authz_groupfile.so
      LoadModule authz_user_module libexec/apache24/mod_authz_user.so
      #LoadModule authz_dbm_module libexec/apache24/mod_authz_dbm.so
      #LoadModule authz_owner_module libexec/apache24/mod_authz_owner.so
      #LoadModule authz_dbd_module libexec/apache24/mod_authz_dbd.so
      LoadModule authz_core_module libexec/apache24/mod_authz_core.so
      #LoadModule authnz_fcgi_module libexec/apache24/mod_authnz_fcgi.so
      LoadModule access_compat_module libexec/apache24/mod_access_compat.so
      LoadModule auth_basic_module libexec/apache24/mod_auth_basic.so
      #LoadModule auth_form_module libexec/apache24/mod_auth_form.so
      #LoadModule auth_digest_module libexec/apache24/mod_auth_digest.so
      #LoadModule allowmethods_module libexec/apache24/mod_allowmethods.so
      #LoadModule file_cache_module libexec/apache24/mod_file_cache.so
      #LoadModule cache_module libexec/apache24/mod_cache.so
      #LoadModule cache_disk_module libexec/apache24/mod_cache_disk.so
      #LoadModule cache_socache_module libexec/apache24/mod_cache_socache.so
      #LoadModule socache_shmcb_module libexec/apache24/mod_socache_shmcb.so
      #LoadModule socache_dbm_module libexec/apache24/mod_socache_dbm.so
      #LoadModule socache_memcache_module libexec/apache24/mod_socache_memcache.so
      #LoadModule watchdog_module libexec/apache24/mod_watchdog.so
      #LoadModule macro_module libexec/apache24/mod_macro.so
      #LoadModule dbd_module libexec/apache24/mod_dbd.so
      #LoadModule dumpio_module libexec/apache24/mod_dumpio.so
      #LoadModule buffer_module libexec/apache24/mod_buffer.so
      #LoadModule data_module libexec/apache24/mod_data.so
      #LoadModule ratelimit_module libexec/apache24/mod_ratelimit.so
      LoadModule reqtimeout_module libexec/apache24/mod_reqtimeout.so
      #LoadModule ext_filter_module libexec/apache24/mod_ext_filter.so
      #LoadModule request_module libexec/apache24/mod_request.so
      #LoadModule include_module libexec/apache24/mod_include.so
      LoadModule filter_module libexec/apache24/mod_filter.so
      #LoadModule reflector_module libexec/apache24/mod_reflector.so
      #LoadModule substitute_module libexec/apache24/mod_substitute.so
      #LoadModule sed_module libexec/apache24/mod_sed.so
      #LoadModule charset_lite_module libexec/apache24/mod_charset_lite.so
      #LoadModule deflate_module libexec/apache24/mod_deflate.so
      LoadModule mime_module libexec/apache24/mod_mime.so
      LoadModule log_config_module libexec/apache24/mod_log_config.so
      #LoadModule log_debug_module libexec/apache24/mod_log_debug.so
      #LoadModule log_forensic_module libexec/apache24/mod_log_forensic.so
      #LoadModule logio_module libexec/apache24/mod_logio.so
      LoadModule env_module libexec/apache24/mod_env.so
      #LoadModule mime_magic_module libexec/apache24/mod_mime_magic.so
      #LoadModule cern_meta_module libexec/apache24/mod_cern_meta.so
      #LoadModule expires_module libexec/apache24/mod_expires.so
      LoadModule headers_module libexec/apache24/mod_headers.so
      #LoadModule usertrack_module libexec/apache24/mod_usertrack.so
      #LoadModule unique_id_module libexec/apache24/mod_unique_id.so
      LoadModule setenvif_module libexec/apache24/mod_setenvif.so
      LoadModule version_module libexec/apache24/mod_version.so
      #LoadModule remoteip_module libexec/apache24/mod_remoteip.so
      #LoadModule proxy_module libexec/apache24/mod_proxy.so
      #LoadModule proxy_connect_module libexec/apache24/mod_proxy_connect.so
      #LoadModule proxy_ftp_module libexec/apache24/mod_proxy_ftp.so
      #LoadModule proxy_http_module libexec/apache24/mod_proxy_http.so
      #LoadModule proxy_fcgi_module libexec/apache24/mod_proxy_fcgi.so
      #LoadModule proxy_scgi_module libexec/apache24/mod_proxy_scgi.so
      #LoadModule proxy_fdpass_module libexec/apache24/mod_proxy_fdpass.so
      #LoadModule proxy_wstunnel_module libexec/apache24/mod_proxy_wstunnel.so
      #LoadModule proxy_ajp_module libexec/apache24/mod_proxy_ajp.so
      #LoadModule proxy_balancer_module libexec/apache24/mod_proxy_balancer.so
      #LoadModule proxy_express_module libexec/apache24/mod_proxy_express.so
      #LoadModule session_module libexec/apache24/mod_session.so
      #LoadModule session_cookie_module libexec/apache24/mod_session_cookie.so
      #LoadModule session_crypto_module libexec/apache24/mod_session_crypto.so
      #LoadModule session_dbd_module libexec/apache24/mod_session_dbd.so
      #LoadModule slotmem_shm_module libexec/apache24/mod_slotmem_shm.so
      #LoadModule slotmem_plain_module libexec/apache24/mod_slotmem_plain.so
      #LoadModule ssl_module libexec/apache24/mod_ssl.so
      #LoadModule dialup_module libexec/apache24/mod_dialup.so
      #LoadModule lbmethod_byrequests_module libexec/apache24/mod_lbmethod_byrequests.so
      #LoadModule lbmethod_bytraffic_module libexec/apache24/mod_lbmethod_bytraffic.so
      #LoadModule lbmethod_bybusyness_module libexec/apache24/mod_lbmethod_bybusyness.so
      #LoadModule lbmethod_heartbeat_module libexec/apache24/mod_lbmethod_heartbeat.so
      #LoadModule mpm_event_module libexec/apache24/mod_mpm_event.so
      LoadModule mpm_prefork_module libexec/apache24/mod_mpm_prefork.so
      #LoadModule mpm_worker_module libexec/apache24/mod_mpm_worker.so
      LoadModule unixd_module libexec/apache24/mod_unixd.so
      #LoadModule heartbeat_module libexec/apache24/mod_heartbeat.so
      #LoadModule heartmonitor_module libexec/apache24/mod_heartmonitor.so
      #LoadModule dav_module libexec/apache24/mod_dav.so
      LoadModule status_module libexec/apache24/mod_status.so
      LoadModule autoindex_module libexec/apache24/mod_autoindex.so
      #LoadModule asis_module libexec/apache24/mod_asis.so
      #LoadModule info_module libexec/apache24/mod_info.so
      <IfModule !mpm_prefork_module>
              #LoadModule cgid_module libexec/apache24/mod_cgid.so
      </IfModule>
      <IfModule mpm_prefork_module>
              #LoadModule cgi_module libexec/apache24/mod_cgi.so
      </IfModule>
      #LoadModule dav_fs_module libexec/apache24/mod_dav_fs.so
      #LoadModule dav_lock_module libexec/apache24/mod_dav_lock.so
      #LoadModule vhost_alias_module libexec/apache24/mod_vhost_alias.so
      #LoadModule negotiation_module libexec/apache24/mod_negotiation.so
      LoadModule dir_module libexec/apache24/mod_dir.so
      #LoadModule imagemap_module libexec/apache24/mod_imagemap.so
      #LoadModule actions_module libexec/apache24/mod_actions.so
      #LoadModule speling_module libexec/apache24/mod_speling.so
      #LoadModule userdir_module libexec/apache24/mod_userdir.so
      LoadModule alias_module libexec/apache24/mod_alias.so
      #LoadModule rewrite_module libexec/apache24/mod_rewrite.so

      # Third party modules
      IncludeOptional etc/apache24/modules.d/[0-9][0-9][0-9]_*.conf

      #Phusion Passanger Apache Module
      LoadModule passenger_module /usr/home/freebsd/src/passenger/buildout/apache2/mod_passenger.so
      <IfModule mod_passenger.c>
        PassengerRoot /usr/home/freebsd/src/passenger
        PassengerDefaultRuby /usr/local/bin/ruby23
      </IfModule>


      <IfModule unixd_module>
      #
      # If you wish httpd to run as a different user or group, you must run
      # httpd as root initially and it will switch.  
      #
      # User/Group: The name (or #number) of the user/group to run httpd as.
      # It is usually good practice to create a dedicated user and group for
      # running httpd, as with most system services.
      #
      User www
      Group www

      </IfModule>

      # 'Main' server configuration
      #
      # The directives in this section set up the values used by the 'main'
      # server, which responds to any requests that aren't handled by a
      # <VirtualHost> definition.  These values also provide defaults for
      # any <VirtualHost> containers you may define later in the file.
      #
      # All of these directives may appear inside <VirtualHost> containers,
      # in which case these default settings will be overridden for the
      # virtual host being defined.
      #

      #
      # ServerAdmin: Your address, where problems with the server should be
      # e-mailed.  This address appears on some server-generated pages, such
      # as error documents.  e.g. admin@your-domain.com
      #
      ServerAdmin you@example.com

      #
      # ServerName gives the name and port that the server uses to identify itself.
      # This can often be determined automatically, but we recommend you specify
      # it explicitly to prevent problems during startup.
      #
      # If your host doesn't have a registered DNS name, enter its IP address here.
      #
      #ServerName www.example.com:80

      #
      # Deny access to the entirety of your server's filesystem. You must
      # explicitly permit access to web content directories in other 
      # <Directory> blocks below.
      #
      <Directory />
          AllowOverride none
          Require all denied
      </Directory>

      #
      # Note that from this point forward you must specifically allow
      # particular features to be enabled - so if something's not working as
      # you might expect, make sure that you have specifically enabled it
      # below.
      #

      #
      # DocumentRoot: The directory out of which you will serve your
      # documents. By default, all requests are taken from this directory, but
      # symbolic links and aliases may be used to point to other locations.
      #
      DocumentRoot "/usr/local/www/apache24/data"
      <Directory "/usr/local/www/apache24/data">
          #
          # Possible values for the Options directive are "None", "All",
          # or any combination of:
          #   Indexes Includes FollowSymLinks SymLinksifOwnerMatch ExecCGI MultiViews
          #
          # Note that "MultiViews" must be named *explicitly* --- "Options All"
          # doesn't give it to you.
          #
          # The Options directive is both complicated and important.  Please see
          # http://httpd.apache.org/docs/2.4/mod/core.html#options
          # for more information.
          #
          Options Indexes FollowSymLinks

          #
          # AllowOverride controls what directives may be placed in .htaccess files.
          # It can be "All", "None", or any combination of the keywords:
          #   AllowOverride FileInfo AuthConfig Limit
          #
          AllowOverride None

          #
          # Controls who can get stuff from this server.
          #
          Require all granted
      </Directory>

      #
      # DirectoryIndex: sets the file that Apache will serve if a directory
      # is requested.
      #
      <IfModule dir_module>
          DirectoryIndex index.html
      </IfModule>

      #
      # The following lines prevent .htaccess and .htpasswd files from being 
      # viewed by Web clients. 
      #
      <Files ".ht*">
          Require all denied
      </Files>

      #
      # ErrorLog: The location of the error log file.
      # If you do not specify an ErrorLog directive within a <VirtualHost>
      # container, error messages relating to that virtual host will be
      # logged here.  If you *do* define an error logfile for a <VirtualHost>
      # container, that host's errors will be logged there and not here.
      #
      ErrorLog "/var/log/httpd-error.log"

      #
      # LogLevel: Control the number of messages logged to the error_log.
      # Possible values include: debug, info, notice, warn, error, crit,
      # alert, emerg.
      #
      LogLevel warn

      <IfModule log_config_module>
          #
          # The following directives define some format nicknames for use with
          # a CustomLog directive (see below).
          #
          LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
          LogFormat "%h %l %u %t \"%r\" %>s %b" common

          <IfModule logio_module>
            # You need to enable mod_logio.c to use %I and %O
            LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
          </IfModule>

          #
          # The location and format of the access logfile (Common Logfile Format).
          # If you do not define any access logfiles within a <VirtualHost>
          # container, they will be logged here.  Contrariwise, if you *do*
          # define per-<VirtualHost> access logfiles, transactions will be
          # logged therein and *not* in this file.
          #
          CustomLog "/var/log/httpd-access.log" common

          #
          # If you prefer a logfile with access, agent, and referer information
          # (Combined Logfile Format) you can use the following directive.
          #
          #CustomLog "/var/log/httpd-access.log" combined
      </IfModule>

      <IfModule alias_module>
          #
          # Redirect: Allows you to tell clients about documents that used to 
          # exist in your server's namespace, but do not anymore. The client 
          # will make a new request for the document at its new location.
          # Example:
          # Redirect permanent /foo http://www.example.com/bar

          #
          # Alias: Maps web paths into filesystem paths and is used to
          # access content that does not live under the DocumentRoot.
          # Example:
          # Alias /webpath /full/filesystem/path
          #
          # If you include a trailing / on /webpath then the server will
          # require it to be present in the URL.  You will also likely
          # need to provide a <Directory> section to allow access to
          # the filesystem path.

          #
          # ScriptAlias: This controls which directories contain server scripts. 
          # ScriptAliases are essentially the same as Aliases, except that
          # documents in the target directory are treated as applications and
          # run by the server when requested rather than as documents sent to the
          # client.  The same rules about trailing "/" apply to ScriptAlias
          # directives as to Alias.
          #
          ScriptAlias /cgi-bin/ "/usr/local/www/apache24/cgi-bin/"

      </IfModule>

      <IfModule cgid_module>
          #
          # ScriptSock: On threaded servers, designate the path to the UNIX
          # socket used to communicate with the CGI daemon of mod_cgid.
          #
          #Scriptsock cgisock
      </IfModule>

      #
      # "/usr/local/www/apache24/cgi-bin" should be changed to whatever your ScriptAliased
      # CGI directory exists, if you have that configured.
      #
      <Directory "/usr/local/www/apache24/cgi-bin">
          AllowOverride None
          Options None
          Require all granted
      </Directory>

      <IfModule mime_module>
          #
          # TypesConfig points to the file containing the list of mappings from
          # filename extension to MIME-type.
          #
          TypesConfig etc/apache24/mime.types

          #
          # AddType allows you to add to or override the MIME configuration
          # file specified in TypesConfig for specific file types.
          #
          #AddType application/x-gzip .tgz
          #
          # AddEncoding allows you to have certain browsers uncompress
          # information on the fly. Note: Not all browsers support this.
          #
          #AddEncoding x-compress .Z
          #AddEncoding x-gzip .gz .tgz
          #
          # If the AddEncoding directives above are commented-out, then you
          # probably should define those extensions to indicate media types:
          #
          AddType application/x-compress .Z
          AddType application/x-gzip .gz .tgz

          #
          # AddHandler allows you to map certain file extensions to "handlers":
          # actions unrelated to filetype. These can be either built into the server
          # or added with the Action directive (see below)
          #
          # To use CGI scripts outside of ScriptAliased directories:
          # (You will also need to add "ExecCGI" to the "Options" directive.)
          #
          #AddHandler cgi-script .cgi

          # For type maps (negotiated resources):
          #AddHandler type-map var

          #
          # Filters allow you to process content before it is sent to the client.
          #
          # To parse .shtml files for server-side includes (SSI):
          # (You will also need to add "Includes" to the "Options" directive.)
          #
          #AddType text/html .shtml
          #AddOutputFilter INCLUDES .shtml
      </IfModule>

      #
      # The mod_mime_magic module allows the server to use various hints from the
      # contents of the file itself to determine its type.  The MIMEMagicFile
      # directive tells the module where the hint definitions are located.
      #
      #MIMEMagicFile etc/apache24/magic

      #
      # Customizable error responses come in three flavors:
      # 1) plain text 2) local redirects 3) external redirects
      #
      # Some examples:
      #ErrorDocument 500 "The server made a boo boo."
      #ErrorDocument 404 /missing.html
      #ErrorDocument 404 "/cgi-bin/missing_handler.pl"
      #ErrorDocument 402 http://www.example.com/subscription_info.html
      #

      #
      # MaxRanges: Maximum number of Ranges in a request before
      # returning the entire resource, or one of the special
      # values 'default', 'none' or 'unlimited'.
      # Default setting is to accept 200 Ranges.
      #MaxRanges unlimited

      #
      # EnableMMAP and EnableSendfile: On systems that support it, 
      # memory-mapping or the sendfile syscall may be used to deliver
      # files.  This usually improves server performance, but must
      # be turned off when serving from networked-mounted 
      # filesystems or if support for these functions is otherwise
      # broken on your system.
      # Defaults: EnableMMAP On, EnableSendfile Off
      #
      #EnableMMAP off
      #EnableSendfile on

      # Supplemental configuration
      #
      # The configuration files in the etc/apache24/extra/ directory can be 
      # included to add extra features or to modify the default configuration of 
      # the server, or you may simply copy their contents here and change as 
      # necessary.

      # Server-pool management (MPM specific)
      #Include etc/apache24/extra/httpd-mpm.conf

      # Multi-language error messages
      #Include etc/apache24/extra/httpd-multilang-errordoc.conf

      # Fancy directory listings
      #Include etc/apache24/extra/httpd-autoindex.conf

      # Language settings
      #Include etc/apache24/extra/httpd-languages.conf

      # User home directories
      #Include etc/apache24/extra/httpd-userdir.conf

      # Real-time info on requests and configuration
      #Include etc/apache24/extra/httpd-info.conf

      # Virtual hosts
      #Include etc/apache24/extra/httpd-vhosts.conf

      # Local access to the Apache HTTP Server Manual
      #Include etc/apache24/extra/httpd-manual.conf

      # Distributed authoring and versioning (WebDAV)
      #Include etc/apache24/extra/httpd-dav.conf

      # Various default settings
      #Include etc/apache24/extra/httpd-default.conf

      # Configure mod_proxy_html to understand HTML4/XHTML1
      <IfModule proxy_html_module>
         Include etc/apache24/extra/proxy-html.conf
      </IfModule>

      # Secure (SSL/TLS) connections
      #Include etc/apache24/extra/httpd-ssl.conf
      #
      # Note: The following must must be present to support
      #       starting without SSL on platforms with no /dev/random equivalent
      #       but a statically compiled-in mod_ssl.
      #
      <IfModule ssl_module>
         SSLRandomSeed startup builtin
         SSLRandomSeed connect builtin
      </IfModule>

      Include etc/apache24/Includes/*.conf

      ##Virtual host config files
      Include etc/apache24/sites-enabled/*.conf

      #Let's Encrypt! 
      <Directory "/usr/local/www/.well-known/">
         Options None
         AllowOverride None
         Require all granted
         Header add Content-Type text/plain
      </Directory>

    #+END_SRC


*** Virtual Hosts Configuration
    - create a directory to keep them
      #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~
        sudo mkdir /usr/local/etc/apache24/sites-enabled
        ls -lh     /usr/local/etc/apache24/ | grep si
      #+END_SRC

      #+RESULTS:
      : drwxr-xr-x  2 root  wheel   512B May  4 03:19 sites-enabled

      - Create [[http://howtounix.info/howto/virtual-host-in-apache-freebsd][virtual host]] file for the site
        This will be tangled with:
        /usr/local/etc/apache24/sites-enabled/mila.conf
        #+BEGIN_SRC sh
          <VirtualHost *:80>
            ServerName mila.cat
            ServerAdmin admin@mila.cat
            DocumentRoot /usr/local/www/mila/current/public/

            ServerAlias www.mila.cat

            RewriteEngine on
            RewriteCond %{SERVER_PORT} !^443$
            RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [NC,R=301,L]

            <Directory />
              Require all granted
              AllowOverride all
              #Passenger:  MultiViews must be turned off.
              Options -MultiViews
              Options FollowSymLinks
             </Directory>

          </VirtualHost>



          <VirtualHost *:443>
            ServerName   mila.cat
            ServerAlias  www.mila.cat
            ServerAdmin  admin@mila.cat
            DocumentRoot /usr/local/www/mila/current/public/

            SSLEngine on
            SSLProtocol all -SSLv2
            SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM

            SSLCertificateFile       /usr/local/etc/letsencrypt.sh/certs/mila.cat/cert.pem
            SSLCertificateKeyFile    /usr/local/etc/letsencrypt.sh/certs/mila.cat/privkey.pem
            SSLCertificateChainFile  /usr/local/etc/letsencrypt.sh/certs/mila.cat/fullchain.pem

            #Environmental variables for Rails.
            #Should get exported  to their own file someday
            SetEnv MILA_DATABASE_PASSWORD 'Password string goes here'
            <Directory />
              Require all granted
              AllowOverride all
              #Passenger:  MultiViews must be turned off.
              Options -MultiViews
              Options FollowSymLinks
            </Directory>

          </VirtualHost>
        #+END_SRC


*** TODO App user/group  accounts on server [0/1]
    :PROPERTIES:
    :ORDERED:  t
    :END:
    - group
      #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~
        sudo pw groupadd rails
        sudo pw groupmod rails -m freebsd
        pw groupshow rails
      #+END_SRC

      #+RESULTS:
      : rails:*:1002:freebsd,mila

    - [ ] user TODO:The default login shell should be changed to
      /bin/false if that does not cause any problems.
       #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~
         sudo pw user add mila -d /home/mila -m -s /usr/local/bin/bash -G rails
         pw usershow mila
       #+END_SRC

       #+RESULTS:
       : mila:*:1002:4294967295::0:0:User &:/home/mila:/bin/bash

    - set up application directory in Apache's webroot.
    The directories permissions are changed to enable the deployment
    user to write.
      #+BEGIN_SRC sh :results output :dir /ssh:freebsd@Mila.cat:~
        sudo mkdir /usr/local/www/mila
        sudo chown -R mila:rails /usr/local/www/mila
        sudo chmod 775 /usr/local/www/mila
        ls -lh /usr/local/www
      #+END_SRC

      #+RESULTS:
      : total 8
      : drwxr-xr-x  6 root  wheel   512B May  4 03:00 apache24
      : drwxrwxr-x  2 mila  rails   512B May  4 03:01 mila


*** Capistrano


***** [[http://capistranorb.com/documentation/getting-started/preparing-your-application/][Initial]] Preparation
      Place Mila into Git
******* Generate keys: 
        - Development :: Vagrant box
          From [[http://unix.stackexchange.com/a/135090/23183][some guy]] comes this trick:
           #+BEGIN_SRC sh :resulats output :dir /ssh:MilaVM:~/
             cat /dev/zero | ssh-keygen -t dsa -q  -N ""
           #+END_SRC

        - Production :: Mila.cat
           #+BEGIN_SRC sh :resulats output :dir /ssh:freebsd@mila.cat:~/
             cat /dev/zero | ssh-keygen -t dsa -q  -N ""
           #+END_SRC

           #+RESULTS:

******* Allow Capistrano to wrtite to /var/www
        #+BEGIN_SRC sh :results output :dir /ssh:freebsd@mila.cat:~/
          sudo mkdir /var/www
          sudo chgrp rails /var/www
          sudo chmod 775 /var/www
        #+END_SRC

        #+RESULTS:

******* TODO Add key to Bitbucket
        Is there some way to script this? Right now, go to
        [[https://bitbucket.org/account/user/MomusLLC/ssh-keys//][Bitbucket SSH key admin]] and add the key.
********* 

******* Initialize git repository
        Git needs a user set to function.
        #+BEGIN_SRC sh :results output :dir /ssh:MilaVM:~/mila/
          git init
          git remote add origin git@bitbucket.org:MomusLLC/mila.git
          git config --global user.email "dmitri@momus.net"
          git config --global user.name "Dmitri G. Brengauz"
          git add .
          git commit -m "initial commit"
          git push -u origin master
        #+END_SRC

        #+RESULTS:
        #+begin_example
        [master (root-commit) 73fd1e8] initial commit
         72 files changed, 15095 insertions(+)
         create mode 100644 .gitignore
         create mode 100644 Capfile
         create mode 100644 Gemfile
         create mode 100644 Gemfile.lock
         create mode 100644 README.rdoc
         create mode 100644 Rakefile
         create mode 100644 app/assets/images/.keep
         create mode 100644 app/assets/javascripts/application.js
         create mode 100644 app/assets/javascripts/static_pages.coffee
         create mode 100644 app/assets/stylesheets/application.css
         create mode 100644 app/assets/stylesheets/static_pages.scss
         create mode 100644 app/controllers/application_controller.rb
         create mode 100644 app/controllers/concerns/.keep
         create mode 100644 app/controllers/static_pages_controller.rb
         create mode 100644 app/helpers/application_helper.rb
         create mode 100644 app/helpers/static_pages_helper.rb
         create mode 100644 app/mailers/.keep
         create mode 100644 app/models/.keep
         create mode 100644 app/models/concerns/.keep
         create mode 100644 app/views/layouts/application.html.erb
         create mode 100644 app/views/static_pages/about.html.erb
         create mode 100644 app/views/static_pages/help.html.erb
         create mode 100644 app/views/static_pages/home.html.erb
         create mode 100755 bin/bundle
         create mode 100755 bin/rails
         create mode 100755 bin/rake
         create mode 100755 bin/setup
         create mode 100755 bin/spring
         create mode 100644 config.ru
         create mode 100644 config/application.rb
         create mode 100644 config/boot.rb
         create mode 100644 config/database.yml
         create mode 100644 config/deploy.rb
         create mode 100644 config/deploy/production.rb
         create mode 100644 config/deploy/staging.rb
         create mode 100644 config/environment.rb
         create mode 100644 config/environments/development.rb
         create mode 100644 config/environments/production.rb
         create mode 100644 config/environments/test.rb
         create mode 100644 config/initializers/assets.rb
         create mode 100644 config/initializers/backtrace_silencers.rb
         create mode 100644 config/initializers/cookies_serializer.rb
         create mode 100644 config/initializers/filter_parameter_logging.rb
         create mode 100644 config/initializers/inflections.rb
         create mode 100644 config/initializers/mime_types.rb
         create mode 100644 config/initializers/session_store.rb
         create mode 100644 config/initializers/wrap_parameters.rb
         create mode 100644 config/locales/en.yml
         create mode 100644 config/routes.rb
         create mode 100644 config/secrets.yml
         create mode 100644 db/schema.rb
         create mode 100644 db/seeds.rb
         create mode 100644 lib/assets/.keep
         create mode 100644 lib/tasks/.keep
         create mode 100644 log/.keep
         create mode 100644 npm-debug.log
         create mode 100644 public/404.html
         create mode 100644 public/422.html
         create mode 100644 public/500.html
         create mode 100644 public/favicon.ico
         create mode 100644 public/robots.txt
         create mode 100644 test/controllers/#_assh_bMilaVM_b_ahome_avagrant_amila_atest_acontrollers_astatic__pages__controller__test.rb#
         create mode 100644 test/controllers/.keep
         create mode 100644 test/controllers/static_pages_controller_test.rb
         create mode 100644 test/fixtures/.keep
         create mode 100644 test/helpers/.keep
         create mode 100644 test/integration/.keep
         create mode 100644 test/mailers/.keep
         create mode 100644 test/models/.keep
         create mode 100644 test/test_helper.rb
         create mode 100644 vendor/assets/javascripts/.keep
         create mode 100644 vendor/assets/stylesheets/.keep
        Branch master set up to track remote branch master from origin.
#+end_example

******* Copy over the new key: 
        - from :: MilaVM:~/.ssh/id_dsa.pub >>
        - to   :: >> Mila.cat:~/.ssh/authorized_keys


***** install Capistrano files
      - initial creation
        #+BEGIN_SRC sh :results output :dir /ssh:MilaVM:~/mila/
         cap install                  
        #+END_SRC

      - new files:
        config/deploy.rb
        config/deploy/staging.rb
        config/deploy/production.rb
        mkdir -p lib/capistrano/tasks
        Capfile

        #+RESULTS:
        : Capified

 
***** config/deploy.rb
      #+BEGIN_SRC ruby :tangle /ssh:MilaVM:mila/config/deploy.rb
              # config valid only for current version of Capistrano
        lock '3.5.0'

        set :application, 'mila'
        set :repo_url, 'git@bitbucket.org:MomusLLC/mila.git'

        # Default branch is :master
        # ask :branch, `git rev-parse --abbrev-ref HEAD`.chomp

        # Default deploy_to directory is /var/www/my_app_name
        set :deploy_to, "/usr/local/www/mila/"

        # Default value for :scm is :git
        # set :scm, :git

        # Default value for :format is :airbrussh.
        set :format, :pretty

        # You can configure the Airbrussh format using :format_options.
        # These are the defaults.
        # set :format_options, command_output: true, log_file: 'log/capistrano.log', color: :auto, truncate: :auto

        # Default value for :pty is false
        set :pty, true

        # Default value for :linked_files is []
        # set :linked_files, fetch(:linked_files, []).push('config/database.yml', 'config/secrets.yml')

        # Default value for linked_dirs is []
        # set :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'public/system')

        # Default value for default_env is {}
        # set :default_env, { path: "/opt/ruby/bin:$PATH" }

        # Default value for keep_releases is 5
        # set :keep_releases, 5

        namespace :deploy do

          after :restart, :clear_cache do
            on roles(:web), in: :groups, limit: 3, wait: 10 do
              # Here we can do anything such as:
              # within release_path do
              #   execute :rake, 'cache:clear'
              # end
            end
          end

        end

      #+END_SRC


***** config/deploy/production.rb
      #+BEGIN_SRC ruby :tangle /ssh:MilaVM:mila/config/deploy/production.rb

        # role-based syntax
        # ==================

        # Defines a role with one or multiple servers. The primary server in each
        # group is considered to be the first unless any  hosts have the primary
        # property set. Specify the username and a domain or IP for the server.
        # Don't use `:all`, it's a meta role.

        # role :app, %w{deploy@example.com}, my_property: :my_value
        # role :web, %w{user1@primary.com user2@additional.com}, other_property: :other_value
        # role :db,  %w{deploy@example.com}

        # Custom SSH Options
        # ==================
        # You may pass any option but keep in mind that net/ssh understands a
        # limited set of options, consult the Net::SSH documentation.
        # http://net-ssh.github.io/net-ssh/classes/Net/SSH.html#method-c-start
        #
        # Global options
        # --------------
        #  set :ssh_options, {
        #    keys: %w(/home/rlisowski/.ssh/id_rsa),
        #    forward_agent: false,
        #    auth_methods: %w(password)
        #  }
        #
        # The server-based syntax can be used to override options:
        # ------------------------------------
         server 'mila.cat',
           user: 'freebsd',
           roles: %w{web db app},
           ssh_options: {
           #keys: %w(/home/user_name/.ssh/id_rsa) ,
             forward_agent: false
           #auth_methods: %w(publickey)
           }

      #+END_SRC



***** initial deployment
      #+BEGIN_SRC sh
      
      #+END_SRC

***** TODO [0/3] Normal deploy tasks
      [[http://stackoverflow.com/a/27434582/768772][This answer]] has a nice summary of what should get done.  These
      should be automated in the deploy/production.rb file.
      - [ ] Initial deployment :: first time cap deploy is run on an application
        #+BEGIN_SRC sh :results output :dir /ssh:freebsd@mila.cat:/usr/local/www/mila/current
          RAILS_ENV=production rake db:setup
        #+END_SRC
      - [ ] Default deployment :: tasks that should be run every time
        #+BEGIN_SRC sh :results output :dir /ssh:freebsd@mila.cat:/usr/local/www/mila/current
          RAILS_ENV=production rake assets:precompile
          RAILS_ENV=production rake db:migrate
        #+END_SRC

        #+RESULTS:

      - [ ] Copy over [DOCUMENTROOT]/mila_config files to
        current/config for database.yml and secrets.yml
        #+BEGIN_SRC sh :results output :dir /ssh:freebsd@mila.cat:/usr/local/www/mila/current/config
          cp /usr/local/www/mila/mila_conf/database.yml  database.yml
          cp /usr/local/www/mila/mila_conf/secrets.yml   secrets.yml
          ls -lh *.yml
        #+END_SRC

        #+RESULTS:
        : -rw-r--r--  1 freebsd  rails   428B May  7 03:43 database.yml
        : -rw-r--r--  1 freebsd  rails   651B May  7 03:43 secrets.yml


* Wrong Turns


*** Elm  [[https://www.npmjs.com/package/elm][Installation]] -- on development only.
    NPM was already installed when installing the Rails gem. However this:
    #+BEGIN_SRC sh :results output :dir /ssh:MilaVM:~/mila/ 
    sudo npm install -g elm
    #+END_SRC
    does not work because there are currently ([2016-04-30 Sat]) no
    FreeBSD binaries in npm. So we have to do it the [[https://github.com/elm-lang/elm-platform][old fasioned]] way:
     1. Get Haskell Working
        #+BEGIN_SRC sh :results output :dir /ssh:MilaVM:~/mila/src
          sudo pkg install --yes lang/ghc
          sudo pkg install --yes hs-cabal-install

        #+END_SRC

        1. New packages to be INSTALLED:
           ghc: 7.10.2
           libiconv: 1.14_9
           gmp: 5.1.3_3
           gcc: 4.8.5_2
           mpc: 1.0.3
           mpfr: 3.1.3_1
           binutils: 2.25.1_1,1
           gcc-ecj: 4.5

           Message from gcc-4.8.5_2:
           To ensure binaries built with this toolchain find appropriate versions
           of the necessary run-time libraries, you may want to link using
     
           -Wl,-rpath=/usr/local/lib/gcc48
      
            For ports leveraging USE_GCC, USES=compiler, or USES=fortran this happens
            transparently.

     2. Actually Build Elm Things
        For some reason, does not build binaries on FreeBSD.




*** Rbenv later? 
    Because of this [[https://www.ixsystems.com/blog/freebsd-on-rails/][iX Systems Article]] I decided on rbenv to install
    ruby.

    #+BEGIN_SRC sh :dir /ssh:MilaVM:~
    sudo pkg install --yes  --quiet devel/rbenv
    #+END_SRC

    - Install the [[https://github.com/rbenv/ruby-build#readme][ruby-build]] plugin to ease install of rubies.
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~
        git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
      #+END_SRC
    - Using ruby-build, fetch and install the proper ruby:
      #+BEGIN_SRC sh :dir /ssh:MilaVM:~
      
      #+END_SRC
